<!doctype html>
<!--
Fishing Catch Report App (Single HTML + Supabase Cloud Sync + Sync Now)
=====================================================================

Works offline:
- If NOT signed in, everything uses localStorage (offline-first).
- If signed in (Supabase Auth), it loads/saves catches to Supabase Postgres and uploads photos to Supabase Storage.

iPhone setup (best)
1) Host via HTTPS (GitHub Pages) OR a local HTTP server (avoid file:// from iCloud/Files).
   - Windows: open Terminal in this folder:  python -m http.server 8000
2) On iPhone Safari open: http://<YOUR-PC-IP>:8000/thisfile.html  (or your GitHub Pages URL)
3) Safari -> Share -> Add to Home Screen

Supabase prerequisites (recommended schema)
- Table: public.catches with columns (at minimum):
  id (uuid PK), user_id (uuid), species (text), caught_at (timestamptz),
  lat (double), lng (double),
  length_value (numeric), length_unit (text),
  weight_lb (int), weight_oz (int check 0..15), weight_total_oz (int),
  bait (text), weather (text), water (text), notes (text),
  photo_path (text), created_at (timestamptz), updated_at (timestamptz)
- Storage bucket: catch-photos (private recommended)
- RLS:
  - catches: user can CRUD where auth.uid() = user_id

Notes
- Photos are compressed to ~800px wide before saving.
- Weight is lb + oz (oz is 0‚Äì15 only).
-->

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b3d2e" />
  <title>Fishing Catch Report</title>

  <link rel="apple-touch-icon" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" width="180" height="180">
    <defs>
      <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
        <stop offset="0" stop-color="%230b3d2e"/>
        <stop offset="1" stop-color="%231a7f6b"/>
      </linearGradient>
    </defs>
    <rect width="180" height="180" rx="36" fill="url(%23g)"/>
    <path d="M40 105c26-30 67-44 104-33-10 9-17 20-18 33 1 13 8 24 18 33-37 11-78-3-104-33z" fill="%23e7fff6"/>
    <circle cx="120" cy="90" r="6" fill="%230b3d2e"/>
    <path d="M32 112c10 12 20 19 34 24" stroke="%23e7fff6" stroke-width="8" stroke-linecap="round"/>
  </svg>' />

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://tqkirvzgmlukiwsplhtk.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_6nX2kXvvJra4uNEv-PGzWA_FCz_uFF3";
    window.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <style>
    :root{
      --bg: #071b16;
      --card: #0b2a23;
      --card2:#0d332a;
      --text:#eafff7;
      --muted:#b8d9cf;
      --warn:#fbbf24;
      --danger:#fb7185;
      --ok:#34d399;
      --border: rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --tap: 48px;
      --font: ui-sans-serif, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f2fbf8;
        --card:#ffffff;
        --card2:#f7fffc;
        --text:#063027;
        --muted:#2a5c51;
        --border: rgba(6,48,39,.12);
        --shadow: 0 10px 30px rgba(0,0,0,.10);
      }
    }

    *, *::before, *::after { box-sizing: border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1200px 800px at 20% -10%, rgba(45,212,191,.18), transparent 60%),
                  radial-gradient(1200px 800px at 90% 10%, rgba(96,165,250,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      overscroll-behavior-y: none;
      overflow-x: hidden;
    }

    input, select, textarea, button { font-size:16px; }
    a{ color:inherit; text-decoration:none; }
    .app{
      max-width: 980px;
      margin: 0 auto;
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom);
      overflow-x: hidden;
    }

    header{
      padding: 14px 6px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap: wrap;
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, rgba(45,212,191,.25), rgba(96,165,250,.20));
      border:1px solid var(--border);
      display:grid; place-items:center;
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .title{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .title b{ font-size:16px; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .title span{ font-size:12px; color:var(--muted); }

    .nav{ display:flex; gap:8px; flex-wrap: wrap; }
    .tab{
      height: var(--tap);
      padding: 0 14px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      display:flex; align-items:center; gap:8px;
      cursor:pointer;
      user-select:none;
      white-space: nowrap;
    }
    .tab[aria-selected="true"]{
      background: linear-gradient(135deg, rgba(45,212,191,.22), rgba(96,165,250,.14));
      border-color: rgba(45,212,191,.35);
      box-shadow: 0 8px 18px rgba(45,212,191,.12);
    }

    @media (max-width: 560px){
      header{ align-items: stretch; }
      .brand{ flex: 1 1 100%; }
      .nav{ flex: 1 1 100%; }
      .tab{ flex: 1 1 calc(50% - 8px); justify-content:center; }
    }

    .wrap{ display:grid; gap:12px; padding: 8px 6px 18px; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-width: 0;
    }
    .card > .hd{
      padding: 14px 14px 10px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--border);
      background: rgba(0,0,0,.02);
      min-width: 0;
    }
    .hd h2{ margin:0; font-size:15px; letter-spacing:.2px; }
    .hd .sub{ margin-top:4px; color:var(--muted); font-size:12px; }
    .bd{ padding: 14px; min-width: 0; }

    .grid{ display:grid; gap:12px; min-width: 0; }
    @media (min-width: 760px){
      .grid.cols2{ grid-template-columns: 1fr 1fr; }
      .grid.cols3{ grid-template-columns: 1fr 1fr 1fr; }
    }

    label{ display:flex; flex-direction:column; gap:6px; font-size:13px; color:var(--muted); min-width:0; }

    input, select, textarea{
      width:100%;
      max-width: 100%;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      padding: 12px 12px;
      color: var(--text);
      outline:none;
      min-width: 0;
      box-sizing: border-box;
    }
    @media (prefers-color-scheme: light){
      input, select, textarea{ background: var(--card2); }
    }
    textarea{ min-height: 96px; resize: vertical; }

    @supports (-webkit-touch-callout: none) {
      input, select, textarea{
        display:block;
        width:100% !important;
        max-width:100% !important;
        min-width:0 !important;
        box-sizing:border-box !important;
        -webkit-appearance:none;
        appearance:none;
        background-clip: padding-box;
      }
      input[type="file"]{ padding: 10px 12px; }
      select{ padding-right: 36px; }
    }

    .row{ display:flex; gap:10px; align-items:center; min-width:0; flex-wrap: wrap; }
    .row > * { flex:1; min-width:0; }

    .btn{
      height: var(--tap);
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color:var(--text);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:0 14px;
      cursor:pointer;
      user-select:none;
      min-width: 0;
    }
    .btn.primary{
      background: linear-gradient(135deg, rgba(45,212,191,.30), rgba(96,165,250,.18));
      border-color: rgba(45,212,191,.38);
    }
    .btn.danger{ background: rgba(251,113,133,.16); border-color: rgba(251,113,133,.35); }
    .btn.small{ height:44px; padding:0 12px; border-radius:12px; flex: 0 0 auto; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      background: rgba(255,255,255,.04);
      max-width: 100%;
    }

    .msg{
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      white-space: pre-line;
      min-width:0;
    }
    .msg.warn{ border-color: rgba(251,191,36,.35); background: rgba(251,191,36,.10); color: var(--text); }
    .msg.ok{ border-color: rgba(52,211,153,.35); background: rgba(52,211,153,.10); color: var(--text); }
    .msg.bad{ border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.10); color: var(--text); }

    .statusLine{
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
    }
    .statusLine.ok{ color: var(--ok); }
    .statusLine.warn{ color: var(--warn); }
    .statusLine.bad{ color: var(--danger); }

    .controls{ display:grid; gap:10px; min-width:0; }
    @media (min-width:760px){
      .controls{ grid-template-columns: 1.4fr 1fr 1fr; }
      .controls .range{ grid-column: span 2; }
    }

    .list{ display:flex; flex-direction:column; gap:10px; min-width:0; }

    details.item{
      border:1px solid var(--border);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(255,255,255,.04);
      min-width:0;
    }
    details.item[open]{ background: rgba(255,255,255,.06); }

    summary{
      list-style:none;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      gap:12px;
      padding: 12px;
      min-height: var(--tap);
      min-width:0;
    }
    summary::-webkit-details-marker{ display:none; }

    .thumb{
      width:52px; height:52px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.08);
      display:grid;
      place-items:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; }

    .meta{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:3px;
      flex:1;
    }
    .meta b{
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .meta span{ font-size:12px; color:var(--muted); }

    .chev{ color:var(--muted); font-size:14px; }

    .detailsBody{ padding: 0 12px 12px; border-top:1px solid var(--border); min-width:0; }

    .photoFull{
      width:100%;
      border-radius: 16px;
      border:1px solid var(--border);
      overflow:hidden;
      background: rgba(0,0,0,.06);
      margin-top: 12px;
    }
    .photoFull img{ width:100%; height:auto; display:block; }

    .kv{ display:grid; gap:10px; margin-top: 12px; min-width:0; }
    @media (min-width:760px){ .kv{ grid-template-columns: 1fr 1fr; } }

    .kv .box{
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,.03);
      min-width:0;
    }
    .k{ font-size:12px; color:var(--muted); }
    .v{ margin-top:3px; font-size:14px; word-break:break-word; }

    .statGrid{ display:grid; gap:10px; min-width:0; }
    @media (min-width:760px){ .statGrid{ grid-template-columns: 1fr 1fr 1fr; } }

    .stat{
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,255,255,.04);
      min-width:0;
    }
    .stat .n{ font-size:22px; font-weight:800; letter-spacing:.3px; }
    .stat .l{ font-size:12px; color:var(--muted); margin-top:2px; }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .footerSpace{ height: 10px; }

    .modalBackdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .modalBackdrop.show{ display:flex; }
    .modal{
      width: min(520px, 100%);
      background: rgba(15, 35, 30, .98);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    @media (prefers-color-scheme: light){
      .modal{ background: rgba(255,255,255,.98); }
    }
    .modal .mhd{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--border);
    }
    .modal .mhd b{ font-size: 15px; }
    .modal .mbd{ padding: 14px; display:grid; gap:10px; }
    .modal .mft{
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      display:flex; gap:10px; justify-content:flex-end;
    }
  </style>
</head>

<body>
  <div class="app" id="app">
    <header>
      <div class="brand" role="banner">
        <div class="logo" aria-hidden="true">üé£</div>
        <div class="title">
          <b>Fishing Catch Report</b>
          <span id="subtitle">Jason's Catch Log</span>
        </div>
      </div>
      <nav class="nav" aria-label="Primary navigation">
        <button class="tab" id="tabAdd" aria-selected="true" aria-controls="viewAdd" type="button">‚ûï Add</button>
        <button class="tab" id="tabCatches" aria-selected="false" aria-controls="viewCatches" type="button">üìö My Catches</button>
        <button class="tab" id="tabStats" aria-selected="false" aria-controls="viewStats" type="button">üìä Stats</button>
        <button class="tab" id="tabTools" aria-selected="false" aria-controls="viewTools" type="button">‚öôÔ∏è Tools</button>
      </nav>
    </header>

    <main class="wrap" role="main">

      <section class="card" id="viewAdd" role="region" aria-label="Add catch">
        <div class="hd">
          <div>
            <h2 id="addTitle">Add Catch</h2>
            <div class="sub">Record species, photo, size/weight, bait, conditions, and location.</div>
          </div>
          <div class="pill" title="Approximate local storage use">üíæ <span id="storageText">‚Äî</span></div>
        </div>
        <div class="bd">
          <div class="grid cols2">
            <label>
              Fish species
              <input id="species" type="text" list="speciesList" autocomplete="off" inputmode="text" aria-label="Fish species" placeholder="e.g., Chub, Pike, Carp" />
              <datalist id="speciesList"></datalist>
            </label>

            <label>
              Date &amp; time
              <input id="datetime" type="datetime-local" aria-label="Date and time" />
            </label>

            <div class="grid cols2">
              <div>
                <div class="row" style="gap:8px; margin-bottom:8px;">
                  <button class="btn small" id="btnGetLocation" type="button" aria-label="Get GPS location">üìç Get location</button>
                  <span class="msg" id="geoMsg" style="flex:1;">Tap ‚ÄúGet location‚Äù to attach GPS.</span>
                </div>
                <span class="pill">üìå <span id="locPill">No location yet</span></span>
              </div>

              <label>
                Photo (camera or library)
                <input id="photo" type="file" accept="image/*" aria-label="Photo upload" />
                <span class="msg" id="photoMsg">Tip: photos are compressed to ~800px wide.</span>
              </label>
            </div>

            <div>
              <label>Length (in / cm)</label>
              <div class="row">
                <input id="lengthVal" type="number" inputmode="decimal" step="0.1" min="0" aria-label="Length value" placeholder="e.g., 18.5" />
                <select id="lengthUnit" aria-label="Length unit">
                  <option value="in">in</option>
                  <option value="cm">cm</option>
                </select>
              </div>
            </div>

            <div>
              <label>Weight (lb / oz)</label>
              <div class="row">
                <input id="weightLb" type="number" inputmode="numeric" step="1" min="0" aria-label="Weight pounds" placeholder="lb" />
                <select id="weightOz" aria-label="Weight ounces (0 to 15)"></select>
              </div>
              <div class="msg" style="margin-top:8px;">Ounces are 0‚Äì15 only.</div>
            </div>

            <div>
              <label>Bait Used</label>
              <div class="row" style="gap:10px;">
                <select id="baitSelect" aria-label="Bait used (select)">
                  <option value="">‚Äî</option>
                </select>
                <button class="btn small" id="btnLastBait" type="button" aria-label="Use last bait">‚Ü∫ Last</button>
              </div>
              <div class="msg" style="margin-top:8px;">Select only (no custom typing).</div>
            </div>

            <label>
              Weather (optional)
              <select id="weather" aria-label="Weather conditions">
                <option value="">‚Äî</option>
                <option>Sunny</option>
                <option>Cloudy</option>
                <option>Rainy</option>
                <option>Windy</option>
              </select>
            </label>

            <label>
              Water conditions (optional)
              <select id="water" aria-label="Water conditions">
                <option value="">‚Äî</option>
                <option>Clear</option>
                <option>Murky</option>
                <option>Choppy</option>
                <option>Calm</option>
              </select>
            </label>

            <label style="grid-column: 1 / -1;">
              Personal notes
              <textarea id="notes" aria-label="Personal notes" placeholder="Spot details, rig, what worked, etc."></textarea>
            </label>
          </div>

          <div class="row" style="margin-top:14px; gap:10px;">
            <button class="btn primary" id="btnSave" type="button" aria-label="Save catch">üíæ Save</button>
            <button class="btn" id="btnReset" type="button" aria-label="Reset form">üßπ Reset</button>
            <button class="btn" id="btnQuickAddHere" type="button" aria-label="Quick add at same location">‚ö° Same spot</button>
          </div>

          <div id="statusLine" class="statusLine" role="status" aria-live="polite"></div>
        </div>
      </section>

      <section class="card" id="viewCatches" role="region" aria-label="My catches" hidden>
        <div class="hd">
          <div>
            <h2>My Catches</h2>
            <div class="sub">Tap an entry to expand details. Search, filter, and sort.</div>
          </div>
          <button class="btn small" id="btnScrollTop" type="button" aria-label="Scroll to top">‚¨ÜÔ∏è</button>
        </div>
        <div class="bd">
          <div class="controls" aria-label="Catch list controls">
            <label>
              Search species
              <input id="searchSpecies" type="text" autocomplete="off" placeholder="Type to filter (e.g., pike)" aria-label="Search by species" />
            </label>
            <label>
              Sort
              <select id="sortBy" aria-label="Sort by">
                <option value="date_desc">Date (newest)</option>
                <option value="date_asc">Date (oldest)</option>
                <option value="species_asc">Species (A‚ÜíZ)</option>
                <option value="species_desc">Species (Z‚ÜíA)</option>
                <option value="length_desc">Length (largest)</option>
                <option value="weight_desc">Weight (heaviest)</option>
              </select>
            </label>
            <div class="range">
              <div class="grid cols2">
                <label>
                  From date
                  <input id="fromDate" type="date" aria-label="From date" />
                </label>
                <label>
                  To date
                  <input id="toDate" type="date" aria-label="To date" />
                </label>
              </div>

              <div class="row" style="margin-top:10px; gap:10px;">
                <button class="btn small" id="btnPresetToday" type="button">üìÖ Today</button>
                <button class="btn small" id="btnPreset7" type="button">üóìÔ∏è Last 7 days</button>
                <button class="btn small" id="btnPresetMonth" type="button">üóìÔ∏è This month</button>
                <button class="btn small" id="btnClearDates" type="button">üßπ Clear dates</button>
              </div>
            </div>
          </div>

          <div class="footerSpace"></div>
          <div class="list" id="catchList" aria-label="Catch entries"></div>
          <div class="msg" id="listMsg" style="margin-top:10px;" aria-live="polite">‚Äî</div>
        </div>
      </section>

      <section class="card" id="viewStats" role="region" aria-label="Statistics" hidden>
        <div class="hd">
          <div>
            <h2>Stats Dashboard</h2>
            <div class="sub">Totals, species breakdown, favorite spots, PB (heaviest) per species.</div>
          </div>
          <button class="btn small" id="btnRefreshStats" type="button" aria-label="Refresh stats">üîÑ</button>
        </div>
        <div class="bd">
          <div class="statGrid" id="statTop"></div>

          <div class="footerSpace"></div>

          <div class="grid cols2">
            <div class="card" style="box-shadow:none;">
              <div class="hd">
                <div>
                  <h2>Species breakdown</h2>
                  <div class="sub">Counts by species (top first).</div>
                </div>
              </div>
              <div class="bd">
                <div id="speciesBreakdown" class="msg">‚Äî</div>
              </div>
            </div>

            <div class="card" style="box-shadow:none;">
              <div class="hd">
                <div>
                  <h2>Favorite spots</h2>
                  <div class="sub">Grouped by approximate coordinates (~0.001¬∞).</div>
                </div>
              </div>
              <div class="bd">
                <div id="favSpots" class="msg">‚Äî</div>
              </div>
            </div>
          </div>

          <div class="footerSpace"></div>

          <div class="card" style="box-shadow:none;">
            <div class="hd">
              <div>
                <h2>PB by species (heaviest)</h2>
                <div class="sub">Pick a species to view the heaviest catch and jump to its details.</div>
              </div>
            </div>
            <div class="bd">
              <div class="grid cols2">
                <label>
                  Select species
                  <select id="pbSpeciesSelect" aria-label="Select species for PB"></select>
                </label>
                <div class="row" style="gap:10px;">
                  <button class="btn primary" id="btnJumpToPb" type="button" aria-label="Jump to PB catch">üìå Jump to PB</button>
                  <button class="btn" id="btnEditPb" type="button" aria-label="Edit PB catch">‚úèÔ∏è Edit PB</button>
                </div>
              </div>

              <div class="footerSpace"></div>
              <div id="pbDetails" class="msg">‚Äî</div>
            </div>
          </div>

          <div class="footerSpace"></div>
          <div class="msg" id="statsMsg" aria-live="polite">‚Äî</div>
        </div>
      </section>

      <section class="card" id="viewTools" role="region" aria-label="Tools" hidden>
        <div class="hd">
          <div>
            <h2>Tools</h2>
            <div class="sub">Backup/restore, export, clear, and cloud sign-in.</div>
          </div>
        </div>
        <div class="bd">
          <div class="grid cols2">
            <div class="card" style="box-shadow:none;">
              <div class="hd">
                <div>
                  <h2>Cloud (Supabase)</h2>
                  <div class="sub">Magic link sign-in. When signed in, saves/loads from cloud + uploads photos.</div>
                </div>
              </div>
              <div class="bd">
                <div class="grid cols2">
                  <label>
                    Email
                    <input id="authEmail" type="email" inputmode="email" autocomplete="email" placeholder="you@example.com" aria-label="Email for magic link" />
                  </label>
                  <div class="row" style="gap:10px;">
                    <button class="btn primary" id="btnSendMagicLink" type="button">‚úâÔ∏è Send link</button>
                    <button class="btn" id="btnSignOut" type="button">üö™ Sign out</button>
                  </div>
                </div>

                <div class="row" style="margin-top:10px; gap:10px;">
                  <button class="btn primary" id="btnSyncNow" type="button" aria-label="Sync now">üîÅ Sync now</button>
                  <button class="btn" id="btnReloadCloud" type="button" aria-label="Reload from cloud">‚òÅÔ∏è Reload cloud</button>
                </div>

                <div class="footerSpace"></div>
                <div class="msg" id="authMsg" aria-live="polite">Not signed in.</div>
                <div class="footerSpace"></div>
                <div class="msg" id="syncMsg" aria-live="polite">‚Äî</div>
              </div>
            </div>

            <div class="card" style="box-shadow:none;">
              <div class="hd">
                <div>
                  <h2>Export / Import</h2>
                  <div class="sub">JSON backup/restore and CSV export.</div>
                </div>
              </div>
              <div class="bd">
                <div class="row" style="gap:10px; flex-wrap:wrap;">
                  <button class="btn primary" id="btnExportJson" type="button" aria-label="Export JSON">‚¨áÔ∏è Export JSON</button>
                  <button class="btn" id="btnExportCsv" type="button" aria-label="Export CSV">üßæ Export CSV</button>
                  <label style="flex:1; min-width: 180px;">
                    Import JSON
                    <input id="importFile" type="file" accept="application/json" aria-label="Import JSON file" />
                  </label>
                </div>
                <div class="footerSpace"></div>
                <div class="msg" id="toolsMsg" aria-live="polite">‚Äî</div>
              </div>
            </div>
          </div>

          <div class="footerSpace"></div>

          <div class="card" style="box-shadow:none;">
            <div class="hd">
              <div>
                <h2>Danger zone</h2>
                <div class="sub">These actions cannot be undone.</div>
              </div>
            </div>
            <div class="bd">
              <button class="btn danger" id="btnClearAll" type="button" aria-label="Clear all data">üóëÔ∏è Clear all data</button>
              <div class="footerSpace"></div>
              <div class="msg warn">Clearing deletes all catches and photos stored in this browser. If signed in, it also clears your cloud rows.</div>
            </div>
          </div>

          <div class="footerSpace"></div>
          <div class="msg" id="pwaMsg">Tip: Add to Home Screen for a more ‚Äúapp-like‚Äù experience.</div>
        </div>
      </section>

    </main>
  </div>

  <!-- Custom modal -->
  <div class="modalBackdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="mhd">
        <b id="modalTitle">Confirm</b>
      </div>
      <div class="mbd">
        <div id="modalText" class="msg" style="margin:0;">‚Äî</div>
        <label id="modalInputWrap" style="display:none;">
          Type to confirm
          <input id="modalInput" type="text" autocomplete="off" />
        </label>
      </div>
      <div class="mft">
        <button class="btn" id="modalCancel" type="button">Cancel</button>
        <button class="btn primary" id="modalOk" type="button">OK</button>
      </div>
    </div>
  </div>

  <script>
    const KEY_PREFIX = "fishingCatchReport.";
    const KEY = "fishingCatchReport.v1";
    const KEY_LAST_BAIT = "fishingCatchReport.lastBait";
    const MAX_IMG_W = 800;
    const IMG_QUALITY = 0.80;
    const SPOT_ROUND = 0.001;

    const SUPABASE_TABLE = "catches";
    const SUPABASE_BUCKET = "catch-photos";
    const SIGNED_URL_SECONDS = 60 * 10;

    const SPECIES_CANON = [
      "Chub","Barbel","Bleak","Bream","Carp","Crucian Carp","Dace","Eel","Grayling",
      "Gudgeon","Perch","Pike","Roach","Rudd","Ruffe","Silver Bream","Tench","Wels Catfish","Zander"
    ];

    const BAIT_OPTIONS = [
      "Maggots","Casters","Worms (lobworms, dendras, redworms)","Sweetcorn",
      "Bread (flake, punch, crust)","Pellets (feed, hook, expanders)","Boilies",
      "Groundbait","Hempseed","Tares","Luncheon meat","Paste","Dead maggots",
      "Bloodworm & joker","Chopped worm and caster mix","Lure"
    ];

    const $ = (id) => document.getElementById(id);

    const els = {
      tabAdd: $("tabAdd"), tabCatches: $("tabCatches"), tabStats: $("tabStats"), tabTools: $("tabTools"),
      viewAdd: $("viewAdd"), viewCatches: $("viewCatches"), viewStats: $("viewStats"), viewTools: $("viewTools"),

      storageText: $("storageText"),
      addTitle: $("addTitle"),

      species: $("species"), speciesList: $("speciesList"),
      datetime: $("datetime"),

      btnGetLocation: $("btnGetLocation"),
      geoMsg: $("geoMsg"),
      locPill: $("locPill"),

      photo: $("photo"), photoMsg: $("photoMsg"),
      lengthVal: $("lengthVal"), lengthUnit: $("lengthUnit"),
      weightLb: $("weightLb"), weightOz: $("weightOz"),
      baitSelect: $("baitSelect"),
      btnLastBait: $("btnLastBait"),

      weather: $("weather"), water: $("water"), notes: $("notes"),
      btnSave: $("btnSave"), btnReset: $("btnReset"), btnQuickAddHere: $("btnQuickAddHere"),
      statusLine: $("statusLine"),

      searchSpecies: $("searchSpecies"), sortBy: $("sortBy"),
      fromDate: $("fromDate"), toDate: $("toDate"),
      btnPresetToday: $("btnPresetToday"),
      btnPreset7: $("btnPreset7"),
      btnPresetMonth: $("btnPresetMonth"),
      btnClearDates: $("btnClearDates"),
      catchList: $("catchList"), listMsg: $("listMsg"),
      btnScrollTop: $("btnScrollTop"),

      statTop: $("statTop"), speciesBreakdown: $("speciesBreakdown"), favSpots: $("favSpots"),
      statsMsg: $("statsMsg"), btnRefreshStats: $("btnRefreshStats"),

      pbSpeciesSelect: $("pbSpeciesSelect"),
      pbDetails: $("pbDetails"),
      btnJumpToPb: $("btnJumpToPb"),
      btnEditPb: $("btnEditPb"),

      authEmail: $("authEmail"),
      btnSendMagicLink: $("btnSendMagicLink"),
      btnSignOut: $("btnSignOut"),
      btnSyncNow: $("btnSyncNow"),
      btnReloadCloud: $("btnReloadCloud"),
      authMsg: $("authMsg"),
      syncMsg: $("syncMsg"),

      btnExportJson: $("btnExportJson"),
      btnExportCsv: $("btnExportCsv"),
      importFile: $("importFile"),
      toolsMsg: $("toolsMsg"),
      btnClearAll: $("btnClearAll"),

      modalBackdrop: $("modalBackdrop"),
      modalTitle: $("modalTitle"),
      modalText: $("modalText"),
      modalInputWrap: $("modalInputWrap"),
      modalInput: $("modalInput"),
      modalCancel: $("modalCancel"),
      modalOk: $("modalOk"),
    };

    const state = {
      db: { version: 1, catches: [] },
      editingId: null,
      lastKnownLocation: null,
      pendingPhotoDataUrl: null,
      pbIndex: new Map(),
      signedUrlCache: new Map(), // photo_path -> { url, expMs }
      authedUserId: null,
      cloudEnabled: false,
      syncInProgress: false,
    };

    function hasSupabase() {
      return !!window.sb;
    }

    async function refreshAuthState() {
      if (!hasSupabase()) {
        state.authedUserId = null;
        state.cloudEnabled = false;
        els.authMsg.textContent = "Supabase not available.";
        return;
      }
      const { data } = await window.sb.auth.getUser();
      state.authedUserId = data?.user?.id ?? null;
      state.cloudEnabled = !!state.authedUserId;
      els.authMsg.textContent = state.cloudEnabled
        ? `Signed in: ${data.user.email}\nCloud sync ON.`
        : "Not signed in.\nOffline mode (local only).";
    }

    function setStatus(type, text) {
      els.statusLine.classList.remove("ok","warn","bad");
      if (type) els.statusLine.classList.add(type);
      els.statusLine.textContent = text || "";
    }

    function showModal({ title="Confirm", text="‚Äî", okText="OK", cancelText="Cancel", requireText=null } = {}) {
      return new Promise((resolve) => {
        els.modalTitle.textContent = title;
        els.modalText.textContent = text;
        els.modalOk.textContent = okText;
        els.modalCancel.textContent = cancelText;

        const needsInput = typeof requireText === "string" && requireText.length > 0;
        els.modalInputWrap.style.display = needsInput ? "" : "none";
        els.modalInput.value = "";
        if (needsInput) els.modalInput.placeholder = requireText;

        const close = (result) => {
          els.modalBackdrop.classList.remove("show");
          els.modalBackdrop.setAttribute("aria-hidden", "true");
          els.modalCancel.onclick = null;
          els.modalOk.onclick = null;
          document.removeEventListener("keydown", onKey);
          resolve(result);
        };

        const onKey = (e) => { if (e.key === "Escape") close(false); };

        els.modalCancel.onclick = () => close(false);
        els.modalOk.onclick = () => {
          if (needsInput && els.modalInput.value !== requireText) {
            els.modalText.textContent = `${text}\n\n(You must type ${requireText} exactly.)`;
            return;
          }
          close(true);
        };

        els.modalBackdrop.classList.add("show");
        els.modalBackdrop.setAttribute("aria-hidden", "false");
        document.addEventListener("keydown", onKey);

        setTimeout(() => (needsInput ? els.modalInput : els.modalOk).focus(), 0);
      });
    }

    function nowLocalDatetimeValue() {
      const d = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function safeParseNumber(s) {
      const t = String(s ?? "").trim();
      if (!t) return null;
      const n = Number(t);
      return Number.isFinite(n) ? n : null;
    }

    function safeParseInt(s) {
      const t = String(s ?? "").trim();
      if (!t) return null;
      const n = parseInt(t, 10);
      return Number.isFinite(n) ? n : null;
    }

    function randomUUIDv4() {
      if (crypto?.randomUUID) return crypto.randomUUID();
      const rnd = crypto?.getRandomValues ? crypto.getRandomValues(new Uint8Array(16)) : Array.from({ length: 16 }, () => Math.floor(Math.random() * 256));
      rnd[6] = (rnd[6] & 0x0f) | 0x40;
      rnd[8] = (rnd[8] & 0x3f) | 0x80;
      const hex = [...rnd].map(b => b.toString(16).padStart(2, "0")).join("");
      return `${hex.slice(0,8)}-${hex.slice(8,12)}-${hex.slice(12,16)}-${hex.slice(16,20)}-${hex.slice(20)}`;
    }

    function isUuid(s) {
      return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(String(s || ""));
    }

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&lt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    function titleCaseWords(input) {
      const s = String(input ?? "").trim();
      if (!s) return "";
      return s.toLowerCase().split(/\s+/).map(w => w ? (w[0].toUpperCase() + w.slice(1)) : "").join(" ");
    }

    function canonSpecies(input) {
      const t = titleCaseWords(input);
      if (!t) return "";
      const hit = SPECIES_CANON.find(x => x.toLowerCase() === t.toLowerCase());
      return hit || t;
    }

    function formatDateTime(iso) {
      try {
        return new Date(iso).toLocaleString(undefined, {
          year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"
        });
      } catch { return iso; }
    }

    function formatLatLng(lat, lng) {
      if (lat == null || lng == null) return "‚Äî";
      const f = (n) => (Math.round(n * 1e6) / 1e6).toFixed(6);
      return `${f(lat)}, ${f(lng)}`;
    }

    function appleMapsLink(lat, lng) {
      if (lat == null || lng == null) return null;
      const q = encodeURIComponent(`${lat},${lng}`);
      return `https://maps.apple.com/?q=${q}&ll=${q}`;
    }

    function setMsg(el, type, text) {
      el.classList.remove("warn","ok","bad");
      if (type) el.classList.add(type);
      el.textContent = text;
    }

    function setLocPill() {
      els.locPill.textContent = state.lastKnownLocation
        ? formatLatLng(state.lastKnownLocation.lat, state.lastKnownLocation.lng)
        : "No location yet";
    }

    function estimateStorageUsageBytes() {
      try {
        let total = 0;
        for (let i = 0; i < localStorage.length; i++) {
          const k = localStorage.key(i);
          const v = localStorage.getItem(k);
          total += (k ? k.length : 0) + (v ? v.length : 0);
        }
        return total * 2;
      } catch { return null; }
    }

    function updateStoragePill() {
      const bytes = estimateStorageUsageBytes();
      if (bytes == null) { els.storageText.textContent = "unknown"; return; }
      els.storageText.textContent = `${(bytes/(1024*1024)).toFixed(2)} MB`;
    }

    function migrateIdsToUuid() {
      let changed = false;
      for (const c of state.db.catches) {
        if (!isUuid(c.id)) {
          c.id = randomUUIDv4();
          changed = true;
        }
      }
      return changed;
    }

    function loadDB() {
      try {
        const raw = localStorage.getItem(KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed && Array.isArray(parsed.catches)) state.db = { version: 1, catches: parsed.catches };
      } catch {}
      if (migrateIdsToUuid()) persistDB();
    }

    function persistDB() {
      try {
        localStorage.setItem(KEY, JSON.stringify(state.db));
        updateStoragePill();
        return { ok: true };
      } catch (e) {
        return { ok: false, error: (e && e.name) ? e.name : "Storage error" };
      }
    }

    async function compressImageToDataUrl(file) {
      const img = new Image();
      const dataUrl = await new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onerror = () => reject(new Error("Failed to read image."));
        r.onload = () => resolve(r.result);
        r.readAsDataURL(file);
      });

      img.src = dataUrl;
      await new Promise((resolve, reject) => {
        img.onload = resolve;
        img.onerror = () => reject(new Error("Could not decode image."));
      });

      const scale = Math.min(1, MAX_IMG_W / img.width);
      const w = Math.round(img.width * scale);
      const h = Math.round(img.height * scale);

      const canvas = document.createElement("canvas");
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext("2d", { alpha: false });
      ctx.drawImage(img, 0, 0, w, h);

      return canvas.toDataURL("image/jpeg", IMG_QUALITY);
    }

    function dataUrlToBlob(dataUrl) {
      const [meta, b64] = String(dataUrl).split(",", 2);
      const bin = atob(b64);
      const bytes = new Uint8Array(bin.length);
      for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
      return new Blob([bytes], { type: "image/jpeg" });
    }

    function setupSpeciesList() {
      els.speciesList.innerHTML = "";
      for (const s of SPECIES_CANON) {
        const opt = document.createElement("option");
        opt.value = s;
        els.speciesList.appendChild(opt);
      }
    }

    function setupBaitSelect() {
      els.baitSelect.innerHTML = "";
      const empty = document.createElement("option");
      empty.value = "";
      empty.textContent = "‚Äî";
      els.baitSelect.appendChild(empty);

      for (const b of BAIT_OPTIONS) {
        const opt = document.createElement("option");
        opt.value = b;
        opt.textContent = b;
        els.baitSelect.appendChild(opt);
      }

      const last = localStorage.getItem(KEY_LAST_BAIT) || "";
      if (last && BAIT_OPTIONS.includes(last)) els.baitSelect.value = last;
    }

    function initOzDropdown() {
      els.weightOz.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "oz";
      els.weightOz.appendChild(placeholder);
      for (let i = 0; i <= 15; i++) {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = `${i} oz`;
        els.weightOz.appendChild(opt);
      }
    }

    function normalizeWeight(lb, oz) {
      let L = lb ?? 0;
      let O = oz ?? 0;
      if (!Number.isFinite(L) || L < 0) L = 0;
      if (!Number.isFinite(O) || O < 0) O = 0;
      if (O > 15) O = 15;
      return { lb: L, oz: O, totalOz: (L * 16) + O };
    }

    function getFormPayload() {
      const species = canonSpecies(els.species.value);
      const dtVal = String(els.datetime.value || "").trim();
      const datetimeISO = dtVal ? new Date(dtVal).toISOString() : "";

      const length = {
        value: safeParseNumber(els.lengthVal.value),
        unit: els.lengthUnit.value === "cm" ? "cm" : "in"
      };

      const lb = safeParseInt(els.weightLb.value);
      const oz = safeParseInt(els.weightOz.value);
      const weight = (lb == null && oz == null)
        ? { lb: null, oz: null, totalOz: null }
        : normalizeWeight(lb ?? 0, oz ?? 0);

      const bait = String(els.baitSelect.value || "").trim();
      const lat = state.lastKnownLocation?.lat ?? null;
      const lng = state.lastKnownLocation?.lng ?? null;

      return {
        species,
        datetimeISO,
        lat,
        lng,
        photoDataUrl: state.pendingPhotoDataUrl,
        length,
        weight,
        bait,
        weather: String(els.weather.value || "").trim(),
        water: String(els.water.value || "").trim(),
        notes: String(els.notes.value || "").trim(),
      };
    }

    function validateForm(payload) {
      const errors = [];
      if (!payload.species) errors.push("Species is required.");
      if (!payload.datetimeISO) errors.push("Date/time is required.");
      if (payload.length.value != null && payload.length.value < 0) errors.push("Length must be >= 0.");
      if (payload.weight.oz != null && (payload.weight.oz < 0 || payload.weight.oz > 15)) errors.push("Ounces must be 0‚Äì15.");
      return errors;
    }

    function resetForm({ keepLocation = false } = {}) {
      state.editingId = null;
      els.addTitle.textContent = "Add Catch";
      els.btnSave.textContent = "üíæ Save";

      els.species.value = "";
      els.datetime.value = nowLocalDatetimeValue();

      if (!keepLocation) state.lastKnownLocation = null;
      setLocPill();

      els.photo.value = "";
      state.pendingPhotoDataUrl = null;
      setMsg(els.photoMsg, "", "Tip: photos are compressed to ~800px wide.");

      els.lengthVal.value = "";
      els.lengthUnit.value = "in";

      els.weightLb.value = "";
      els.weightOz.value = "";

      const last = localStorage.getItem(KEY_LAST_BAIT) || "";
      els.baitSelect.value = (last && BAIT_OPTIONS.includes(last)) ? last : "";

      els.weather.value = "";
      els.water.value = "";
      els.notes.value = "";

      setStatus("", "");
    }

    function upsertCatch(payload) {
      const nowIso = new Date().toISOString();
      if (state.editingId) {
        const idx = state.db.catches.findIndex(c => c.id === state.editingId);
        if (idx >= 0) {
          state.db.catches[idx] = { ...state.db.catches[idx], ...payload, updatedAtISO: nowIso };
          return { id: state.editingId, mode: "updated" };
        }
      }
      const c = { id: randomUUIDv4(), ...payload, createdAtISO: nowIso, updatedAtISO: nowIso, photo_path: null };
      state.db.catches.push(c);
      return { id: c.id, mode: "created" };
    }

    function deleteCatchLocal(id) {
      const n0 = state.db.catches.length;
      state.db.catches = state.db.catches.filter(c => c.id !== id);
      return state.db.catches.length !== n0;
    }

    function toDatetimeLocalValue(iso) {
      try {
        const d = new Date(iso);
        const pad = (n) => String(n).padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
      } catch { return nowLocalDatetimeValue(); }
    }

    function startEdit(id) {
      const c = state.db.catches.find(x => x.id === id);
      if (!c) return;

      state.editingId = id;
      els.addTitle.textContent = "Edit Catch";
      els.btnSave.textContent = "‚úÖ Update";

      els.species.value = c.species || "";
      els.datetime.value = toDatetimeLocalValue(c.datetimeISO);

      state.lastKnownLocation = (c.lat != null && c.lng != null) ? { lat: c.lat, lng: c.lng } : null;
      setLocPill();

      state.pendingPhotoDataUrl = c.photoDataUrl || null;
      els.photo.value = "";
      setMsg(els.photoMsg, "", c.photoDataUrl ? "Existing photo kept (choose a new one to replace)." : (c.photo_path ? "Photo in cloud (choose a new one to replace)." : "No photo saved."));

      els.lengthVal.value = (c.length?.value != null) ? String(c.length.value) : "";
      els.lengthUnit.value = (c.length?.unit === "cm") ? "cm" : "in";

      els.weightLb.value = (c.weight?.lb != null) ? String(c.weight.lb) : "";
      els.weightOz.value = (c.weight?.oz != null) ? String(c.weight.oz) : "";

      els.baitSelect.value = BAIT_OPTIONS.includes(c.bait) ? c.bait : "";
      els.weather.value = c.weather || "";
      els.water.value = c.water || "";
      els.notes.value = c.notes || "";

      switchView("add");
      setStatus("ok", "Editing loaded. Tap ‚ÄúGet location‚Äù to update coordinates if needed.");
    }

    function applyFiltersAndSort(items) {
      const q = String(els.searchSpecies.value || "").trim().toLowerCase();
      const from = els.fromDate.value ? new Date(`${els.fromDate.value}T00:00:00`) : null;
      const to = els.toDate.value ? new Date(`${els.toDate.value}T23:59:59`) : null;

      let out = items.slice();
      if (q) out = out.filter(c => String(c.species || "").toLowerCase().includes(q));
      if (from) out = out.filter(c => new Date(c.datetimeISO).getTime() >= from.getTime());
      if (to) out = out.filter(c => new Date(c.datetimeISO).getTime() <= to.getTime());

      const sort = els.sortBy.value;
      const byStr = (a, b) => String(a).localeCompare(String(b), undefined, { sensitivity: "base" });

      if (sort === "date_desc") out.sort((a,b)=> new Date(b.datetimeISO) - new Date(a.datetimeISO));
      if (sort === "date_asc") out.sort((a,b)=> new Date(a.datetimeISO) - new Date(b.datetimeISO));
      if (sort === "species_asc") out.sort((a,b)=> byStr(a.species, b.species));
      if (sort === "species_desc") out.sort((a,b)=> byStr(b.species, a.species));
      if (sort === "length_desc") out.sort((a,b)=> (b.length?.value ?? -Infinity) - (a.length?.value ?? -Infinity));
      if (sort === "weight_desc") out.sort((a,b)=> (b.weight?.totalOz ?? -Infinity) - (a.weight?.totalOz ?? -Infinity));

      return out;
    }

    async function getSignedUrl(photoPath) {
      if (!state.cloudEnabled || !photoPath) return null;
      const cached = state.signedUrlCache.get(photoPath);
      const now = Date.now();
      if (cached && cached.expMs > now) return cached.url;

      const { data, error } = await window.sb.storage.from(SUPABASE_BUCKET).createSignedUrl(photoPath, SIGNED_URL_SECONDS);
      if (error || !data?.signedUrl) return null;

      state.signedUrlCache.set(photoPath, { url: data.signedUrl, expMs: now + (SIGNED_URL_SECONDS - 10) * 1000 });
      return data.signedUrl;
    }

    async function ensureCloudPhotoUrl(imgEl, c) {
      if (!c?.photo_path) return;
      const url = await getSignedUrl(c.photo_path);
      if (url) imgEl.src = url;
    }

    async function renderList({ openId = null } = {}) {
      const items = applyFiltersAndSort(state.db.catches);
      els.catchList.innerHTML = "";

      if (!items.length) {
        els.listMsg.textContent = "No catches match your filters yet.";
        return;
      }

      const frag = document.createDocumentFragment();

      for (const c of items) {
        const details = document.createElement("details");
        details.className = "item";
        details.dataset.id = c.id;

        const summary = document.createElement("summary");

        const thumb = document.createElement("div");
        thumb.className = "thumb";

        if (c.photoDataUrl) {
          const img = document.createElement("img");
          img.loading = "lazy";
          img.alt = `${c.species || "Fish"} thumbnail`;
          img.src = c.photoDataUrl;
          thumb.appendChild(img);
        } else if (c.photo_path && state.cloudEnabled) {
          const img = document.createElement("img");
          img.loading = "lazy";
          img.alt = `${c.species || "Fish"} thumbnail`;
          img.src = "data:image/gif;base64,R0lGODlhAQABAAAAACw=";
          thumb.appendChild(img);
          ensureCloudPhotoUrl(img, c);
        } else {
          thumb.textContent = "üì∑";
        }

        const meta = document.createElement("div");
        meta.className = "meta";
        const title = document.createElement("b");
        title.textContent = c.species || "‚Äî";
        const sub = document.createElement("span");
        sub.innerHTML = `${escapeHtml(formatDateTime(c.datetimeISO))} ‚Ä¢ <span class="mono">${escapeHtml(formatLatLng(c.lat, c.lng))}</span>`;
        meta.appendChild(title);
        meta.appendChild(sub);

        const chev = document.createElement("div");
        chev.className = "chev";
        chev.textContent = "‚ñæ";

        summary.appendChild(thumb);
        summary.appendChild(meta);
        summary.appendChild(chev);

        const body = document.createElement("div");
        body.className = "detailsBody";

        if (c.photoDataUrl) {
          const ph = document.createElement("div");
          ph.className = "photoFull";
          const img = document.createElement("img");
          img.loading = "lazy";
          img.alt = `${c.species || "Fish"} photo`;
          img.src = c.photoDataUrl;
          ph.appendChild(img);
          body.appendChild(ph);
        } else if (c.photo_path && state.cloudEnabled) {
          const ph = document.createElement("div");
          ph.className = "photoFull";
          const img = document.createElement("img");
          img.loading = "lazy";
          img.alt = `${c.species || "Fish"} photo`;
          img.src = "data:image/gif;base64,R0lGODlhAQABAAAAACw=";
          ph.appendChild(img);
          body.appendChild(ph);
          ensureCloudPhotoUrl(img, c);
        }

        const kv = document.createElement("div");
        kv.className = "kv";

        const lenText = (c.length?.value != null) ? `${c.length.value} ${c.length.unit}` : "‚Äî";
        const wtText = (c.weight?.totalOz != null) ? `${c.weight.lb} lb ${c.weight.oz} oz` : "‚Äî";

        const kvBox = (k, v, isHtml=false) => {
          const box = document.createElement("div");
          box.className = "box";
          const kEl = document.createElement("div");
          kEl.className = "k";
          kEl.textContent = k;
          const vEl = document.createElement("div");
          vEl.className = "v";
          vEl.innerHTML = isHtml ? v : escapeHtml(v);
          box.appendChild(kEl);
          box.appendChild(vEl);
          return box;
        };

        kv.appendChild(kvBox("Species", c.species || "‚Äî"));
        kv.appendChild(kvBox("Date & time", formatDateTime(c.datetimeISO)));
        kv.appendChild(kvBox("Location", `<span class="mono">${escapeHtml(formatLatLng(c.lat, c.lng))}</span>`, true));
        kv.appendChild(kvBox("Length", lenText));
        kv.appendChild(kvBox("Weight", wtText));
        kv.appendChild(kvBox("Bait Used", c.bait || "‚Äî"));
        kv.appendChild(kvBox("Weather", c.weather || "‚Äî"));
        kv.appendChild(kvBox("Water", c.water || "‚Äî"));
        kv.appendChild(kvBox("Notes", c.notes || "‚Äî"));

        body.appendChild(kv);

        const actions = document.createElement("div");
        actions.className = "row";
        actions.style.gap = "10px";
        actions.style.marginTop = "12px";

        const btnEdit = document.createElement("button");
        btnEdit.className = "btn small";
        btnEdit.type = "button";
        btnEdit.textContent = "‚úèÔ∏è Edit";
        btnEdit.addEventListener("click", (e) => {
          e.preventDefault(); e.stopPropagation();
          startEdit(c.id);
        });

        const btnDel = document.createElement("button");
        btnDel.className = "btn small danger";
        btnDel.type = "button";
        btnDel.textContent = "üóëÔ∏è Delete";
        btnDel.addEventListener("click", async (e) => {
          e.preventDefault(); e.stopPropagation();

          const ok = await showModal({
            title: "Delete catch",
            text: `Delete this catch (${c.species})? This cannot be undone.`,
            okText: "Delete",
            cancelText: "Cancel"
          });
          if (!ok) return;

          if (state.cloudEnabled) {
            try {
              if (c.photo_path) {
                await window.sb.storage.from(SUPABASE_BUCKET).remove([c.photo_path]);
                state.signedUrlCache.delete(c.photo_path);
              }
              await window.sb.from(SUPABASE_TABLE).delete().eq("id", c.id).eq("user_id", state.authedUserId);
            } catch {}
          }

          deleteCatchLocal(c.id);
          persistDB();
          await renderList();
          renderStats();
        });

        const mapA = document.createElement("a");
        mapA.className = "btn small";
        mapA.textContent = "üó∫Ô∏è Open in Maps";
        const mapUrl = appleMapsLink(c.lat, c.lng);
        if (mapUrl) {
          mapA.href = mapUrl;
          mapA.target = "_blank";
          mapA.rel = "noopener";
        } else {
          mapA.href = "#";
          mapA.style.opacity = ".55";
          mapA.addEventListener("click", (e) => e.preventDefault());
        }

        actions.appendChild(btnEdit);
        actions.appendChild(btnDel);
        actions.appendChild(mapA);
        body.appendChild(actions);

        details.appendChild(summary);
        details.appendChild(body);
        frag.appendChild(details);

        if (openId && c.id === openId) details.open = true;
      }

      els.catchList.appendChild(frag);
      els.listMsg.textContent = `${items.length} catch${items.length === 1 ? "" : "es"} shown.`;
    }

    function computePbIndex() {
      const pb = new Map();
      for (const c of state.db.catches) {
        const s = String(c.species || "").trim();
        if (!s) continue;
        if (c.weight?.totalOz == null) continue;
        const prev = pb.get(s);
        if (!prev || (c.weight.totalOz > prev.weight.totalOz)) pb.set(s, c);
      }
      state.pbIndex = new Map(Array.from(pb.entries()).map(([s,c]) => [s, c.id]));
      return pb;
    }

    function setupPbSpeciesSelect(speciesIterable) {
      const prev = els.pbSpeciesSelect.value || "";
      const list = Array.from(speciesIterable).sort((a,b)=> a.localeCompare(b, undefined, { sensitivity:"base" }));

      els.pbSpeciesSelect.innerHTML = "";
      const empty = document.createElement("option");
      empty.value = "";
      empty.textContent = "‚Äî";
      els.pbSpeciesSelect.appendChild(empty);

      for (const s of list) {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        els.pbSpeciesSelect.appendChild(opt);
      }

      if (prev && list.includes(prev)) els.pbSpeciesSelect.value = prev;
      else els.pbSpeciesSelect.value = list[0] || "";
    }

    function renderPbDetails() {
      const species = els.pbSpeciesSelect.value || "";
      if (!species) {
        els.pbDetails.textContent = "Pick a species to view PB.";
        els.btnJumpToPb.disabled = true;
        els.btnEditPb.disabled = true;
        return;
      }

      const catchId = state.pbIndex.get(species);
      const c = state.db.catches.find(x => x.id === catchId);
      if (!c) {
        els.pbDetails.textContent = "No PB for this species yet (add a weight).";
        els.btnJumpToPb.disabled = true;
        els.btnEditPb.disabled = true;
        return;
      }

      const mapUrl = appleMapsLink(c.lat, c.lng);
      const wtText = (c.weight?.totalOz != null) ? `${c.weight.lb} lb ${c.weight.oz} oz` : "‚Äî";
      const lenText = (c.length?.value != null) ? `${c.length.value} ${c.length.unit}` : "‚Äî";

      els.pbDetails.innerHTML =
        `PB Catch: <b>${escapeHtml(species)}</b>\n` +
        `Weight: <b>${escapeHtml(wtText)}</b>\n` +
        `Length: ${escapeHtml(lenText)}\n` +
        `Date: ${escapeHtml(formatDateTime(c.datetimeISO))}\n` +
        `Location: <span class="mono">${escapeHtml(formatLatLng(c.lat, c.lng))}</span>` +
        (mapUrl ? `\nMaps: <a href="${mapUrl}" target="_blank" rel="noopener">open</a>` : "");

      els.btnJumpToPb.disabled = false;
      els.btnEditPb.disabled = false;
    }

    function renderStats() {
      const items = state.db.catches.slice();
      const total = items.length;

      const speciesCounts = new Map();
      for (const c of items) {
        const s = String(c.species || "Unknown").trim() || "Unknown";
        speciesCounts.set(s, (speciesCounts.get(s) || 0) + 1);
      }

      const topSpecies = Array.from(speciesCounts.entries()).sort((a,b)=> b[1]-a[1])[0]?.[0] || "‚Äî";
      const biggestLen = items.filter(c => c.length?.value != null).sort((a,b)=> b.length.value - a.length.value)[0] || null;
      const biggestWt = items.filter(c => c.weight?.totalOz != null).sort((a,b)=> b.weight.totalOz - a.weight.totalOz)[0] || null;

      els.statTop.innerHTML =
        `<div class="stat"><div class="n">${total}</div><div class="l">Total catches</div></div>` +
        `<div class="stat"><div class="n">${speciesCounts.size || 0}</div><div class="l">Distinct species</div></div>` +
        `<div class="stat"><div class="n">${escapeHtml(String(topSpecies))}</div><div class="l">Most common species</div></div>`;

      const breakdown = Array.from(speciesCounts.entries()).sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0]));
      els.speciesBreakdown.textContent = breakdown.length
        ? breakdown.slice(0, 18).map(([s,n]) => `‚Ä¢ ${s}: ${n}`).join("\n")
        : "No data yet.";

      const spotCounts = new Map();
      for (const c of items) {
        if (c.lat == null || c.lng == null) continue;
        const rLat = Math.round(c.lat / SPOT_ROUND) * SPOT_ROUND;
        const rLng = Math.round(c.lng / SPOT_ROUND) * SPOT_ROUND;
        const key = `${rLat.toFixed(3)},${rLng.toFixed(3)}`;
        spotCounts.set(key, (spotCounts.get(key) || 0) + 1);
      }
      const fav = Array.from(spotCounts.entries()).sort((a,b)=> b[1]-a[1]).slice(0, 8);
      if (!fav.length) els.favSpots.textContent = "No location data yet.";
      else {
        els.favSpots.innerHTML = fav.map(([k,n]) => {
          const [a,b] = k.split(",");
          const lat = Number(a), lng = Number(b);
          const url = appleMapsLink(lat, lng);
          return `‚Ä¢ <span class="mono">${escapeHtml(k)}</span> ‚Äî ${n} catch${n===1?"":"es"}${url ? ` (<a href="${url}" target="_blank" rel="noopener">open</a>)` : ""}`;
        }).join("<br/>");
      }

      const bLenTxt = biggestLen ? `${biggestLen.species} ‚Äî ${biggestLen.length.value} ${biggestLen.length.unit}` : "‚Äî";
      const bWtTxt = biggestWt ? `${biggestWt.species} ‚Äî ${biggestWt.weight.lb} lb ${biggestWt.weight.oz} oz` : "‚Äî";
      els.statsMsg.textContent = `Biggest (length): ${bLenTxt} ‚Ä¢ Biggest (weight): ${bWtTxt}`;

      const pbMap = computePbIndex();
      setupPbSpeciesSelect(pbMap.keys());
      renderPbDetails();

      updateStoragePill();
    }

    function switchView(which) {
      const map = {
        add: [els.tabAdd, els.viewAdd],
        catches: [els.tabCatches, els.viewCatches],
        stats: [els.tabStats, els.viewStats],
        tools: [els.tabTools, els.viewTools],
      };

      for (const k of Object.keys(map)) {
        const [tab, view] = map[k];
        const on = (k === which);
        tab.setAttribute("aria-selected", on ? "true" : "false");
        view.hidden = !on;
      }

      if (which === "catches") renderList();
      if (which === "stats") renderStats();
      if (which === "add") updateStoragePill();
    }

    function getLocation() {
      if (!("geolocation" in navigator)) {
        els.geoMsg.textContent = "Geolocation not available. You can still save without location.";
        return;
      }

      els.geoMsg.textContent = "Requesting location permission‚Ä¶";
      els.btnGetLocation.disabled = true;

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          els.btnGetLocation.disabled = false;
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          state.lastKnownLocation = { lat, lng };
          setLocPill();
          els.geoMsg.textContent = `Captured: ${formatLatLng(lat, lng)}`;
          els.geoMsg.className = "msg ok";
        },
        (err) => {
          els.btnGetLocation.disabled = false;
          const reason = (err && err.code === 1)
            ? "Permission denied. You can still save without location."
            : "Could not get location. Try again.";
          els.geoMsg.textContent = reason;
          els.geoMsg.className = "msg warn";
        },
        { enableHighAccuracy: true, timeout: 12000, maximumAge: 15000 }
      );
    }

    async function onPhotoChosen() {
      const file = els.photo.files && els.photo.files[0];
      if (!file) return;
      if (!file.type.startsWith("image/")) {
        setMsg(els.photoMsg, "warn", "That file doesn't look like an image.");
        state.pendingPhotoDataUrl = null;
        return;
      }
      setMsg(els.photoMsg, "", "Compressing photo‚Ä¶");
      try {
        state.pendingPhotoDataUrl = await compressImageToDataUrl(file);
        setMsg(els.photoMsg, "ok", "Image compressed and ready.");
      } catch (e) {
        state.pendingPhotoDataUrl = null;
        setMsg(els.photoMsg, "bad", `Photo failed: ${e.message || "unknown error"}`);
      }
    }

    function exportJSON() {
      const payload = { exportedAtISO: new Date().toISOString(), app: "FishingCatchReport", version: 1, data: state.db };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      const stamp = new Date().toISOString().slice(0,19).replace(/:/g,"-");
      a.download = `catch-log-backup-${stamp}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
      setMsg(els.toolsMsg, "ok", "Export JSON started.");
    }

    function csvEscape(val) {
      const s = String(val ?? "");
      if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }

    function exportCSV() {
      const rows = [];
      rows.push([
        "id","species","datetimeISO","lat","lng","appleMapsUrl",
        "lengthValue","lengthUnit",
        "weightLb","weightOz","weightTotalOz",
        "bait","weather","water","notes",
        "hasPhotoOffline","photoPathCloud",
        "createdAtISO","updatedAtISO"
      ]);

      for (const c of state.db.catches) {
        const mapsUrl = appleMapsLink(c.lat, c.lng) || "";
        rows.push([
          c.id,
          c.species || "",
          c.datetimeISO || "",
          c.lat ?? "",
          c.lng ?? "",
          mapsUrl,
          c.length?.value ?? "",
          c.length?.unit ?? "",
          c.weight?.lb ?? "",
          c.weight?.oz ?? "",
          c.weight?.totalOz ?? "",
          c.bait || "",
          c.weather || "",
          c.water || "",
          c.notes || "",
          c.photoDataUrl ? "true" : "false",
          c.photo_path || "",
          c.createdAtISO || "",
          c.updatedAtISO || ""
        ]);
      }

      const csv = rows.map(r => r.map(csvEscape).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      const stamp = new Date().toISOString().slice(0,19).replace(/:/g,"-");
      a.download = `catch-log-${stamp}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);

      setMsg(els.toolsMsg, "ok", "Export CSV started (no image bytes; includes cloud photo path if any).");
    }

    async function importJSON(file) {
      if (!file) return;
      try {
        const txt = await file.text();
        const parsed = JSON.parse(txt);
        const data = parsed?.data;
        if (!data || !Array.isArray(data.catches)) {
          setMsg(els.toolsMsg, "bad", "Invalid backup file: missing data.catches.");
          return;
        }

        const ok = await showModal({
          title: "Import backup",
          text: `Import will REPLACE your current catches (${state.db.catches.length}) with imported (${data.catches.length}). Continue?`,
          okText: "Import",
          cancelText: "Cancel"
        });
        if (!ok) return;

        state.db = { version: 1, catches: data.catches.slice() };
        migrateIdsToUuid();
        const res = persistDB();
        if (!res.ok) { setMsg(els.toolsMsg, "bad", `Imported but could not save locally: ${res.error}`); return; }

        setMsg(els.toolsMsg, "ok", `Imported ${state.db.catches.length} catches (local).`);
        await renderList();
        renderStats();
      } catch (e) {
        setMsg(els.toolsMsg, "bad", `Import failed: ${e.message || "unknown error"}`);
      } finally {
        els.importFile.value = "";
      }
    }

    function ymd(d) {
      const pad = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    function setDateRange(from, to) {
      els.fromDate.value = from ? ymd(from) : "";
      els.toDate.value = to ? ymd(to) : "";
      renderList();
    }

    async function loadFromSupabase(userId) {
      try {
        setMsg(els.toolsMsg, "", "Loading from cloud‚Ä¶");
        const { data, error } = await window.sb
          .from(SUPABASE_TABLE)
          .select("*")
          .eq("user_id", userId);

        if (error) {
          setMsg(els.toolsMsg, "warn", `Cloud load failed; using offline data. (${error.message})`);
          return;
        }

        state.db = {
          version: 1,
          catches: (data || []).map(r => ({
            id: r.id,
            species: r.species,
            datetimeISO: r.caught_at,
            lat: r.lat,
            lng: r.lng,
            length: { value: r.length_value, unit: r.length_unit || "in" },
            weight: (r.weight_total_oz == null)
              ? { lb: null, oz: null, totalOz: null }
              : { lb: r.weight_lb ?? 0, oz: r.weight_oz ?? 0, totalOz: r.weight_total_oz ?? 0 },
            bait: r.bait || "",
            weather: r.weather || "",
            water: r.water || "",
            notes: r.notes || "",
            photoDataUrl: null,
            photo_path: r.photo_path || null,
            createdAtISO: r.created_at || null,
            updatedAtISO: r.updated_at || null,
          }))
        };

        persistDB();
        setMsg(els.toolsMsg, "ok", `Cloud loaded: ${state.db.catches.length} catches.`);
      } catch (e) {
        setMsg(els.toolsMsg, "warn", `Cloud load failed; using offline data. (${e.message || "error"})`);
      }
    }

    async function upsertCatchToSupabase(userId, c) {
      const row = {
        id: c.id,
        user_id: userId,
        species: c.species,
        caught_at: c.datetimeISO,
        lat: c.lat,
        lng: c.lng,
        length_value: c.length?.value ?? null,
        length_unit: c.length?.unit ?? null,
        weight_lb: c.weight?.lb ?? null,
        weight_oz: c.weight?.oz ?? null,
        weight_total_oz: c.weight?.totalOz ?? null,
        bait: c.bait || null,
        weather: c.weather || null,
        water: c.water || null,
        notes: c.notes || null,
        photo_path: c.photo_path || null,
      };

      const { error } = await window.sb.from(SUPABASE_TABLE).upsert(row, { onConflict: "id" });
      if (error) throw error;
    }

    async function uploadPhotoToStorage(userId, catchId, dataUrl) {
      const blob = dataUrlToBlob(dataUrl);
      const path = `${userId}/${catchId}.jpg`;

      const { error } = await window.sb.storage
        .from(SUPABASE_BUCKET)
        .upload(path, blob, { upsert: true, contentType: "image/jpeg" });

      if (error) throw error;
      state.signedUrlCache.delete(path);
      return path;
    }

    async function syncNow() {
      if (!state.cloudEnabled) {
        setMsg(els.syncMsg, "warn", "Sign in first to sync.");
        return;
      }
      if (state.syncInProgress) return;

      state.syncInProgress = true;
      els.btnSyncNow.disabled = true;
      els.btnReloadCloud.disabled = true;

      try {
        const total = state.db.catches.length;
        let okRows = 0;
        let okPhotos = 0;
        let failed = 0;

        setMsg(els.syncMsg, "", `Syncing ${total} catches‚Ä¶`);

        for (let i = 0; i < total; i++) {
          const c = state.db.catches[i];
          try {
            // Upload offline photo if present (and either not uploaded yet, or we want to overwrite)
            if (c.photoDataUrl && !c.photo_path) {
              const path = await uploadPhotoToStorage(state.authedUserId, c.id, c.photoDataUrl);
              c.photo_path = path;
              okPhotos++;
              persistDB();
            }

            await upsertCatchToSupabase(state.authedUserId, c);
            okRows++;

            if (i % 3 === 0 || i === total - 1) {
              setMsg(els.syncMsg, "", `Sync progress: ${i + 1}/${total} (rows ok: ${okRows}, photos uploaded: ${okPhotos}, failed: ${failed})`);
            }
          } catch {
            failed++;
            setMsg(els.syncMsg, "warn", `Sync progress: ${i + 1}/${total} (rows ok: ${okRows}, photos uploaded: ${okPhotos}, failed: ${failed})`);
          }
        }

        setMsg(els.syncMsg, failed ? "warn" : "ok",
          `Sync complete. Rows ok: ${okRows}/${total}. Photos uploaded: ${okPhotos}. Failed: ${failed}.`);
        await renderList();
        renderStats();
      } finally {
        state.syncInProgress = false;
        els.btnSyncNow.disabled = false;
        els.btnReloadCloud.disabled = false;
      }
    }

    async function sendMagicLink(email) {
      const clean = String(email || "").trim();
      if (!clean) {
        setMsg(els.authMsg, "warn", "Enter an email first.");
        return;
      }
      setMsg(els.authMsg, "", "Sending magic link‚Ä¶");
      const { error } = await window.sb.auth.signInWithOtp({
        email: clean,
        options: { emailRedirectTo: window.location.origin + window.location.pathname }
      });
      if (error) {
        setMsg(els.authMsg, "bad", `Could not send link: ${error.message}`);
        return;
      }
      setMsg(els.authMsg, "ok", "Link sent. Open it from your email on this device/browser.");
    }

    async function signOut() {
      await window.sb.auth.signOut();
      await refreshAuthState();
      setMsg(els.toolsMsg, "", "Signed out. Offline mode (local only).");
      setMsg(els.syncMsg, "", "‚Äî");
      await renderList();
      renderStats();
    }

    async function clearAll() {
      const ok1 = await showModal({
        title: "Clear all data",
        text: "This will delete ALL catches stored in this browser. If signed in, it also deletes your cloud rows.",
        okText: "Continue",
        cancelText: "Cancel"
      });
      if (!ok1) { setMsg(els.toolsMsg, "warn", "Clear cancelled."); return; }

      const ok2 = await showModal({
        title: "Final confirmation",
        text: "Type DELETE to confirm.",
        okText: "Delete all",
        cancelText: "Cancel",
        requireText: "DELETE"
      });
      if (!ok2) { setMsg(els.toolsMsg, "warn", "Clear cancelled."); return; }

      if (state.cloudEnabled) {
        try {
          await window.sb.from(SUPABASE_TABLE).delete().eq("user_id", state.authedUserId);
          const paths = state.db.catches.map(c => c.photo_path).filter(Boolean);
          if (paths.length) await window.sb.storage.from(SUPABASE_BUCKET).remove(paths);
          state.signedUrlCache.clear();
        } catch {}
      }

      try {
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const k = localStorage.key(i);
          if (k && k.startsWith(KEY_PREFIX)) keysToRemove.push(k);
        }
        for (const k of keysToRemove) localStorage.removeItem(k);
      } catch {}

      state.db = { version: 1, catches: [] };
      persistDB();

      await renderList();
      renderStats();
      resetForm();
      setMsg(els.toolsMsg, "ok", "All data cleared.");
      setMsg(els.syncMsg, "", "‚Äî");
    }

    function wireEvents() {
      els.tabAdd.addEventListener("click", () => switchView("add"));
      els.tabCatches.addEventListener("click", () => switchView("catches"));
      els.tabStats.addEventListener("click", () => switchView("stats"));
      els.tabTools.addEventListener("click", () => switchView("tools"));

      els.btnGetLocation.addEventListener("click", getLocation);
      els.photo.addEventListener("change", onPhotoChosen);

      els.baitSelect.addEventListener("change", () => {
        const v = String(els.baitSelect.value || "").trim();
        if (v) localStorage.setItem(KEY_LAST_BAIT, v);
      });

      els.btnLastBait.addEventListener("click", () => {
        const last = localStorage.getItem(KEY_LAST_BAIT) || "";
        if (last && BAIT_OPTIONS.includes(last)) els.baitSelect.value = last;
      });

      const normalizeSpeciesField = () => {
        const canon = canonSpecies(els.species.value);
        if (canon && canon !== els.species.value) els.species.value = canon;
      };
      els.species.addEventListener("blur", normalizeSpeciesField);
      els.species.addEventListener("change", normalizeSpeciesField);

      els.btnReset.addEventListener("click", () => resetForm());
      els.btnQuickAddHere.addEventListener("click", () => {
        resetForm({ keepLocation: true });
        setStatus("ok", "Form reset; kept last known spot.");
      });

      els.btnSave.addEventListener("click", async () => {
        const payload = getFormPayload();

        if (payload.weight.totalOz != null) {
          els.weightLb.value = String(payload.weight.lb);
          els.weightOz.value = String(payload.weight.oz);
        }

        const errors = validateForm(payload);
        if (errors.length) { setStatus("bad", errors.join(" ")); return; }

        if (payload.bait) localStorage.setItem(KEY_LAST_BAIT, payload.bait);

        const resUpsert = upsertCatch(payload);
        const c = state.db.catches.find(x => x.id === resUpsert.id);

        const resStore = persistDB();
        if (!resStore.ok) {
          if (payload.photoDataUrl) {
            const ok = await showModal({
              title: "Storage full",
              text: "Storage is full. Save WITHOUT the photo?",
              okText: "Save without photo",
              cancelText: "Cancel"
            });
            if (!ok) return;

            if (c) c.photoDataUrl = null;
            state.pendingPhotoDataUrl = null;
            const retry = persistDB();
            if (!retry.ok) { setStatus("bad", `Could not save locally (${retry.error}).`); return; }
            setStatus("warn", "Saved without photo due to local storage limits.");
          } else {
            setStatus("bad", `Could not save locally (${resStore.error}).`);
            return;
          }
        }

        if (state.cloudEnabled && c) {
          try {
            setStatus("", "Syncing to cloud‚Ä¶");

            if (state.pendingPhotoDataUrl) {
              const path = await uploadPhotoToStorage(state.authedUserId, c.id, state.pendingPhotoDataUrl);
              c.photo_path = path;
            }

            await upsertCatchToSupabase(state.authedUserId, c);
            setStatus("ok", resUpsert.mode === "updated" ? "Catch updated (cloud synced)." : "Catch saved (cloud synced).");
          } catch (e) {
            setStatus("warn", `Saved locally, but cloud sync failed: ${e.message || "error"}`);
          }
        } else {
          setStatus("ok", resUpsert.mode === "updated" ? "Catch updated (offline)." : "Catch saved (offline).");
        }

        state.pendingPhotoDataUrl = null;
        await renderList();
        renderStats();
        resetForm({ keepLocation: true });
      });

      const rerender = () => renderList();
      els.searchSpecies.addEventListener("input", rerender);
      els.sortBy.addEventListener("change", rerender);
      els.fromDate.addEventListener("change", rerender);
      els.toDate.addEventListener("change", rerender);

      els.btnPresetToday.addEventListener("click", () => {
        const d = new Date();
        setDateRange(d, d);
      });
      els.btnPreset7.addEventListener("click", () => {
        const to = new Date();
        const from = new Date();
        from.setDate(from.getDate() - 6);
        setDateRange(from, to);
      });
      els.btnPresetMonth.addEventListener("click", () => {
        const now = new Date();
        const from = new Date(now.getFullYear(), now.getMonth(), 1);
        const to = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        setDateRange(from, to);
      });
      els.btnClearDates.addEventListener("click", () => setDateRange(null, null));

      els.btnScrollTop.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));
      els.btnRefreshStats.addEventListener("click", renderStats);

      els.pbSpeciesSelect.addEventListener("change", () => {
        computePbIndex();
        renderPbDetails();
      });

      els.btnJumpToPb.addEventListener("click", async () => {
        const species = els.pbSpeciesSelect.value || "";
        const id = state.pbIndex.get(species);
        if (!id) return;
        switchView("catches");
        await renderList({ openId: id });
        const el = Array.from(document.querySelectorAll("details.item")).find(x => x.dataset.id === id);
        if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
      });

      els.btnEditPb.addEventListener("click", () => {
        const species = els.pbSpeciesSelect.value || "";
        const id = state.pbIndex.get(species);
        if (id) startEdit(id);
      });

      els.btnExportJson.addEventListener("click", exportJSON);
      els.btnExportCsv.addEventListener("click", exportCSV);
      els.importFile.addEventListener("change", () => {
        const f = els.importFile.files && els.importFile.files[0];
        if (f) importJSON(f);
      });

      els.btnClearAll.addEventListener("click", clearAll);

      // Auth
      els.btnSendMagicLink.addEventListener("click", () => sendMagicLink(els.authEmail.value));
      els.btnSignOut.addEventListener("click", signOut);

      // Sync
      els.btnSyncNow.addEventListener("click", syncNow);
      els.btnReloadCloud.addEventListener("click", async () => {
        if (!state.cloudEnabled) { setMsg(els.syncMsg, "warn", "Sign in first to reload."); return; }
        await loadFromSupabase(state.authedUserId);
        await renderList();
        renderStats();
        setMsg(els.syncMsg, "ok", "Reloaded from cloud.");
      });
    }

    async function init() {
      setupSpeciesList();
      setupBaitSelect();
      initOzDropdown();

      loadDB();
      updateStoragePill();

      els.datetime.value = nowLocalDatetimeValue();
      els.sortBy.value = "date_desc";
      setLocPill();
      setStatus("", "");

      await refreshAuthState();
      if (state.cloudEnabled) await loadFromSupabase(state.authedUserId);

      await renderList();
      renderStats();
      wireEvents();

      if (hasSupabase()) {
        window.sb.auth.onAuthStateChange(async () => {
          await refreshAuthState();
          if (state.cloudEnabled) await loadFromSupabase(state.authedUserId);
          await renderList();
          renderStats();
        });
      }
    }

    init();
  </script>
</body>
</html>
